<html>
    
<script type="text/javascript" src="./lib/vie-latest-ALL.debug.js"></script>
<script type="text/javascript" src="./lib/jquery.rdfquery.js"></script>

<script>
      window.terkait = {

          vie : function() {
              var v = new VIE();
              v.loadSchema("lib/schemaOrg/all.json", {
                baseNS : "http://schema.org/",
                success : function () {
                    // this needs to be done here, as "loadSchema" works asynchronously
                    
                    // assemble context menue
                    chrome.contextMenus.create({
                        type : "normal",
                        title : "Annotate as...",
                        contexts : [ "selection" ]
                    });
                
                    chrome.contextMenus.create({
                        type : "separator",
                        contexts : [ "selection" ]
                    });
                
                    var thing = window.terkait.vie.types.get("Thing").hierarchy();
                    window.terkait.appendType(null, thing.id, thing.subtypes);
                
                    chrome.contextMenus.create({
                        type : "separator",
                        contexts : [ "selection" ]
                    });
                
                    for ( var i = 0; i < window.terkait.config.commonTypes.length; i++) {
                        var type = window.terkait.vie.types.get(
                                window.terkait.config.commonTypes[i]).hierarchy();
                        window.terkait.appendType(null, type.id, type.subtypes);
                    }
                }
              });
              return v;
          }(),
              
          appendType : function(parentId, id, subtypes) {
            var sid = VIE.Util.toCurie(id, false, window.terkait.vie.namespaces);
            var options = {
                title : sid,
                parentId : parentId,
                contexts : [ "selection" ],
                onclick : function(id) {
                    return function(data, window) {
                        chrome.tabs.getSelected(null, function(tab) {
                            chrome.tabs.sendRequest(tab.id, {
                                action : "annotateSelectionAs",
                                args : { id : id }
                            });
                        });
                    };
                }(id)
            };
            if (parentId === null)
                delete options["parentId"];

            var menuId = chrome.contextMenus.create(options);

            for ( var i = 0; i < subtypes.length; i++) {
                window.terkait.appendType(menuId, subtypes[i].id, subtypes[i].subtypes);
            }
        },

        config : {
            commonTypes : [ "Person", "Organization", "Product", "Place" ]
        }
    };

    //React when a browser action's icon is clicked.
    chrome.browserAction.onClicked.addListener(function(tab) {
        chrome.tabs.getSelected(null, function(tab) {
            chrome.tabs.sendRequest(tab.id, {
                action : "create"
            }, function(response) {
                if (response.success) {
                    chrome.tabs.sendRequest(tab.id, {
                        action : "recommend"
                    }, function(response) {
                        if (response.success) {
                            //TODO
                        } else {
                            //TODO
                        }
                    });
                } else {
                    //TODO
                }
            });
        });
    });

    
</script>
</html>
