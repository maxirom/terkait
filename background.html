<html>
    
<script type="text/javascript" src="resources/fancy-settings/lib/store.js"></script>
<script type="text/javascript" src="./lib/vie-latest-ALL.debug.js"></script>
<script type="text/javascript" src="./lib/jquery.rdfquery.js"></script>

<script>

	var defaults = {
		commonTypes : [ "Person", "Organization", "Product", "Place" ],
		filterTypes : [],
		maxEntities : 5,
		language : "en",
		baseNamespace : "http://schema.org/",
		schemaDefintion: "lib/schemaOrg/all.json",
		stanbol: "http://dev.iks-project.eu/stanbolfull,http://dev.iks-project.eu:8081",
		created: false
	};

    window.terkait = {
    		  
    	settings : function () {
    		var sett = new Store("settings", defaults).toObject();

    		if (sett.filterCheckboxPlace)
    			jQuery.merge(sett.filterTypes, ["Place"]);
    		if (sett.filterCheckboxPerson)
    			jQuery.merge(sett.filterTypes, ["Person"]);
    		if (sett.filterCheckboxOrganization)
    			jQuery.merge(sett.filterTypes, ["Organization"]);
    		if (sett.filterCheckboxProduct)
    			jQuery.merge(sett.filterTypes, ["Product"]);
    		
    		return sett;
    	}()
          
    };
      
    jQuery.extend(window.terkait, {

          vie : function() {
              var v = new VIE();
              v.loadSchema(window.terkait.settings.schemaDefintion, {
                baseNS : window.terkait.settings.baseNamespace,
                success : function () {
                    // assemble context menue
                    chrome.contextMenus.create({
                        type : "normal",
                        title : "Annotate as...",
                        contexts : [ "selection" ]
                    });
                
                    chrome.contextMenus.create({
                        type : "separator",
                        contexts : [ "selection" ]
                    });
                
                    var thing = window.terkait.vie.types.get("Thing").hierarchy();
                    window.terkait.appendType(null, thing.id, thing.subtypes);
                
                    chrome.contextMenus.create({
                        type : "separator",
                        contexts : [ "selection" ]
                    });
                    
                    for ( var i = 0; i < window.terkait.settings.commonTypes.length; i++) {
                        var type = window.terkait.vie.types.get(
                                window.terkait.settings.commonTypes[i]).hierarchy();
                        window.terkait.appendType(null, type.id, type.subtypes);
                    }
                }
              });
              return v;
          }(),
              
          appendType : function(parentId, id, subtypes) {
            var sid = VIE.Util.toCurie(id, false, window.terkait.vie.namespaces);
            var options = {
                title : sid,
                parentId : parentId,
                contexts : [ "selection" ],
                onclick : function(id) {
                    return function(data, window) {
                        chrome.tabs.getSelected(null, function(tab) {
                            chrome.tabs.sendRequest(tab.id, {
                                action : "annotateSelectionAs",
                                args : { id : id }
                            });
                        });
                    };
                }(id)
            };
            if (parentId === null)
                delete options["parentId"];

            var menuId = chrome.contextMenus.create(options);

            for ( var i = 0; i < subtypes.length; i++) {
                window.terkait.appendType(menuId, subtypes[i].id, subtypes[i].subtypes);
            }
        }
    });

    //React when a browser action's icon is clicked.
    chrome.browserAction.onClicked.addListener(function(tab) {
        chrome.tabs.getSelected(null, function(tab) {
        	var destroy = window.terkait.settings.created;
        	
            chrome.tabs.sendRequest(tab.id, {
                action : (destroy)? "destroy" : "create"
            }, function (response) {
                if (!destroy && response.success) {
                	window.terkait.settings.created = true;
                    chrome.tabs.sendRequest(tab.id, {
                        action : "recommend"
                    }, function(response) {
                        if (response.error) {
                            console.log(response.error)
                        }
                    });
                } else if (destroy) {
                	window.terkait.settings.created = false;
                } else if (response.error) {
                    console.log(response.error)
                }
            });
        });
    });
    
    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
   		if (request.action == 'gpmeGetOptions') {
   			sendResponse(window.terkait.settings);
   	    }
   	});

    
</script>
</html>
