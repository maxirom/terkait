<html>
    
<script type="text/javascript" src="resources/fancy-settings/lib/store.js"></script>
<script type="text/javascript" src="./lib/vie-latest-ALL.debug.js"></script>
<script type="text/javascript" src="./lib/jquery.rdfquery.js"></script>

<script>

	var defaults = {
		commonTypes : [ "Person", "Organization", "Product", "Place" ],
		filterTypes : ["Place"/*, "Person", "Organization", "Product"*/],
		"max-entities" : 5,
		language : "en",
		baseNamespace : "http://schema.org",
		schemaDefintion: "lib/schemaOrg/all.json",
		stanbol: "http://dev.iks-project.eu/stanbolfull,http://dev.iks-project.eu:8081"
	};

    window.terkait = {
    		  
    	settings : new Store("settings", defaults).toObject(),
          
    };
      
    jQuery.extend(window.terkait, {

          vie : function() {
              var v = new VIE();
              v.loadSchema(window.terkait.settings.schemaDefintion, {
                baseNS : window.terkait.settings.baseNamespace,
                success : function () {
                    // assemble context menue
                    chrome.contextMenus.create({
                        type : "normal",
                        title : "Annotate as...",
                        contexts : [ "selection" ]
                    });
                
                    chrome.contextMenus.create({
                        type : "separator",
                        contexts : [ "selection" ]
                    });
                
                    var thing = window.terkait.vie.types.get("Thing").hierarchy();
                    window.terkait.appendType(null, thing.id, thing.subtypes);
                
                    chrome.contextMenus.create({
                        type : "separator",
                        contexts : [ "selection" ]
                    });
                    
                    for ( var i = 0; i < window.terkait.settings.commonTypes.length; i++) {
                        var type = window.terkait.vie.types.get(
                                window.terkait.settings.commonTypes[i]).hierarchy();
                        window.terkait.appendType(null, type.id, type.subtypes);
                    }
                }
              });
              return v;
          }(),
              
          appendType : function(parentId, id, subtypes) {
            var sid = VIE.Util.toCurie(id, false, window.terkait.vie.namespaces);
            var options = {
                title : sid,
                parentId : parentId,
                contexts : [ "selection" ],
                onclick : function(id) {
                    return function(data, window) {
                        chrome.tabs.getSelected(null, function(tab) {
                            chrome.tabs.sendRequest(tab.id, {
                                action : "annotateSelectionAs",
                                args : { id : id }
                            });
                        });
                    };
                }(id)
            };
            if (parentId === null)
                delete options["parentId"];

            var menuId = chrome.contextMenus.create(options);

            for ( var i = 0; i < subtypes.length; i++) {
                window.terkait.appendType(menuId, subtypes[i].id, subtypes[i].subtypes);
            }
        }
    });

    //React when a browser action's icon is clicked.
    chrome.browserAction.onClicked.addListener(function(tab) {
        chrome.tabs.getSelected(null, function(tab) {
            chrome.tabs.sendRequest(tab.id, {
                action : "create"
            }, function(response) {
                if (response.success) {
                    chrome.tabs.sendRequest(tab.id, {
                        action : "recommend"
                    }, function(response) {
                        if (response.success) {
                            //TODO
                        } else {
                            //TODO
                        }
                    });
                } else {
                    //TODO
                }
            });
        });
    });
    
    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
   		if (request.action == 'gpmeGetOptions') {
   			sendResponse(window.terkait.settings);
   	    }
   	});

    
</script>
</html>
